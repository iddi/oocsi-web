var OOCSI=function(){var o,a,i="ws://localhost/ws",c={},r={},u={},f=function(n){},t=function(){};function s(){f("CONNECTING to "+i),(a=new WebSocket(i)).onopen=n,a.onclose=e,a.onmessage=E,a.onerror=S}function n(n){a.readyState===WebSocket.OPEN&&N(o),f("CONNECTED")}function e(n){f("DISCONNECTED")}function E(n){if("ping"!==n.data){try{var t,e=JSON.parse(n.data);e.data.hasOwnProperty("_MESSAGE_ID")&&u.hasOwnProperty(e.data._MESSAGE_ID)?(t=u[e.data._MESSAGE_ID],+new Date<t.expiration&&(delete e.data._MESSAGE_ID,t.fn(e.data)),delete u[e.data._MESSAGE_ID]):void 0!==c[e.recipient]?c[e.recipient](e):f("no handler for event: "+n.data)}catch(e){f("ERROR: parse exception for event data "+n.data)}f("RESPONSE: "+n.data)}else 0<n.data.length&&a.send(".")}function S(n){t(),f("ERROR: "+n)}function d(n){a&&a.readyState!==WebSocket.CONNECTING?n():setTimeout(function(){d(n)},200)}function N(n){a&&a.send(n)&&f("SENT: "+n)}function b(){return a.readyState===WebSocket.OPEN}function l(n,t){b()&&N("sendjson "+n+" "+JSON.stringify(t))}function O(n,t,e,o){var a;function i(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}b()&&(a=i()+i()+"-"+i()+"-"+i()+"-"+i()+"-"+i()+i()+i(),u[a]={expiration:+new Date+e,fn:o},t._MESSAGE_ID=a,N("sendjson "+(t._MESSAGE_HANDLE=n)+" "+JSON.stringify(t)))}function _(n,t){b()&&(N("subscribe "+n),c[n]=t)}function h(){b()||a.readyState===WebSocket.CONNECTING||(f("RECONNECTING"),s(),d(function(){for(const n in c)N("subscribe "+n)}))}return{connect:function(n,t,e){i=n,o=t&&0<t.length?t:"webclient_"+ +new Date,c[o]=e,s(),setInterval(h,1e3)},send:function(n,t){d(function(){l(n,t)})},call:function(n,t,e,o){d(function(){O(n,t,e,o)})},register:function(t,o){d(function(){var n,e;n=t,e=o,b()&&(r[n]={fn:e},_(n,function(n){var t={_MESSAGE_ID:n.data._MESSAGE_ID};e(n.data,t),l(n.sender,t)}))})},subscribe:function(n,t){d(function(){_(n,t)})},unsubscribe:function(t){d(function(){var n;n=t,b()&&(N("unsubscribe "+n),c[n]=function(){})})},variable:function(e,t){var o,a=[];function i(n){var t;return arguments.length&&n!==o&&(t=o=n,a.forEach(function(n){n(t)}),l(e,{name:o})),o}return i.subscribe=function(n){a.push(n)},this.subscribe(e,function(n){n.data.hasOwnProperty(t)&&i(n.data[t])}),i},isConnected:b,close:function(){d(function(){a&&a.close()})},handlers:function(){return c},logger:function(n){f=n},error:function(n){t=n}}}();
