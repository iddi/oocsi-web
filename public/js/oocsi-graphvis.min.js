function oocsiGraphVis(a,t,e=""){const n=document.querySelector(a);if(!n)return;let r="",c=e;const l=d3.select(a).append("svg").attr("class","graph").attr("width",n.clientWidth).attr("height",n.clientHeight);var e=+l.attr("width"),s=+l.attr("height");const i=d3.forceSimulation().force("link",d3.forceLink().id(t=>t.id).distance(120).strength(t=>t.strength||0)).force("charge",d3.forceManyBody().strength(-50)).force("center",d3.forceCenter(e/2,s/2)),o={id:"center",type:"server",label:"",value:2};let d=[o],p=1,u=[],g=l.append("g"),h=l.append("g"),f=l.append("g");const v=()=>{const t=g.selectAll(".link").data(u).join("line").attr("class",t=>"client"===t.type?"link client":"channel"===t.type?"link channel":"subscription"===t.type?"link subscription":"link").attr("opacity",t=>{return e=t,0==r.length||y(e.source)&&y(e.target)?t.ttl<+Date.now()?.5:1:0;var e}),e=h.selectAll(".node").data(d,t=>t.id).attr("opacity",t=>y(t)?1:0).join(t=>t.append("circle").attr("class",t=>"node "+t.type).attr("r",t=>5*t.value).call(d3.drag().on("start",x).on("drag",m).on("end",w)),t=>t,t=>t.remove()),n=f.selectAll(".label").data(d,t=>t.id).attr("opacity",t=>y(t)?1:0).join(t=>t.append("text").attr("class","label").text(t=>t.label).attr("dx",10).attr("dy",3),t=>t,t=>t.remove());i.nodes(d).on("tick",()=>{t.attr("x1",t=>t.source.x).attr("y1",t=>t.source.y).attr("x2",t=>t.target.x).attr("y2",t=>t.target.y),e.attr("cx",t=>t.x).attr("cy",t=>t.y),n.attr("x",t=>t.x).attr("y",t=>t.y)}),i.force("link").links(u),i.alpha(1).restart()};function y(t){return 0==r.length||"client"!==t.type||t.chains.some(t=>t.toLowerCase().includes(r))}function x(t,e){t.active||i.alphaTarget(.3).restart(),e.fx=e.x,e.fy=e.y}function m(t,e){e.fx=t.x,e.fy=t.y}function w(t,e){t.active||i.alphaTarget(0),e.fx=null,e.fy=null}function b(t){var n=t.split("/").filter(t=>0<t.length);let a=o,r="clients";for(index in n){var s=n[index];r+="/"+s,(target=a)!==o&&target.chains.push(t);let e=C(r);e?u.find(t=>t.source===e&&t.target===target)||(S(e,target,"client",1),v()):(S(e=k(r,s,0,"client",t),target,"client",1),d.push(e),v()),a=e}}function k(t,e,n,a,r){return{id:p++,qualName:t,label:e,value:1,type:a,chains:[r]}}function C(e){return d.find(t=>t.qualName===e)}function S(t,e,n,a){u.push({id:p++,source:t,target:e,type:n,strength:a,ttl:+Date.now()+3e4})}function O(e,a,r=[]){if(r=Array.isArray(r)?r:[r],0==c.length||a.toLowerCase().includes(c)){L++;let t=C("clients/"+e),n=(t||(b(e),t=C("clients/"+e)),C("channels/"+a));if(!n){{var s=a;var i=s.split("/").filter(t=>0<t.length);let t=o,n="channels";for(index in i){var l=i[index];n+="/"+l,target=t;let e=C(n);e?u.find(t=>t.source===e&&t.target===target)||(S(e,target,"channel",.5),v()):(S(e=k(n,l,0,"channel"),target,"channel",target===o?1:.2),d.push(e),v()),t=e}}n=C("channels/"+a)}s=function(t,e){var n=[t],a=new Set,r=new Map;a.add(t.id);for(;0<n.length;){const i=n.shift();if(i.id===e.id){var s=[];let t=e;for(;t;)s.unshift(t),t=r.get(t.id);return s}for(const l of u.filter(t=>"subscription"!==t.type).filter(t=>t.source.id===i.id||t.target.id===i.id).map(t=>t.source.id===i.id?t.target:t.source))a.has(l.id)||(a.add(l.id),r.set(l.id,i),n.push(l))}return[]}(t,n);A(s,e.includes("tool")&&e.includes("gen")?" generated":""),setTimeout(()=>{r.filter(t=>2<t.length).forEach(t=>{let e=C("clients/"+t);e||(b(t),e=C("clients/"+t)),u.find(t=>t.source===n&&t.target===e)||(S(n,e,"subscription",0),v()),A([n,e]," shadow")})},800*(s.length-1))}}function A(r,t=""){if(!(r.length<2)&&r.every(t=>y(t))){const i=l.append("circle").attr("class","moving-dot"+t).attr("r",4).attr("cx",r[0].x).attr("cy",r[0].y);var e=800*(r.length-1);var s=e/(100*(r.length-1));for(let a=0;a<r.length-1;a++){var n=function(e,n){return u.find(t=>t.source===e&&t.target===n||t.source===n&&t.target===e)}(r[a],r[a+1]);n&&(n.ttl=+Date.now()+3e4);for(let n=0;n<=100;n++)setTimeout(()=>{var t=n/100,e=r[a].x+t*(r[a+1].x-r[a].x),t=r[a].y+t*(r[a+1].y-r[a].y);i.attr("cx",e).attr("cy",t)},n*s+a*e/(r.length-1))}setTimeout(()=>{i.remove()},e)}}v(),OOCSI.connect(t,"OOCSI/tools/oocsiGraphVis_####"),OOCSI.subscribe("OOCSI_events",t=>{O(t.data.PUB,t.data.CHANNEL,t.data.SUB)}),!n||n.clientWidth<960||n.clientHeight<400||(d3.select(a).append("div").attr("class","widget search").html(`<span class="text">Filter clients:</span>
                <br>
                <input type="search">`),d3.select(a+" .search input").on("input",()=>{r=d3.select(a+" .search input").property("value").toLowerCase(),v()}));let L=0;function T(e){const r=d3.select(e+" .sparkline").attr("width",300).attr("height",60);let n=[0,0,0,0];function a(t){const n=d3.scaleLinear().domain([0,t.length-1]).range([0,3*(t.length-1)]),e=d3.scaleLinear().domain([0,d3.max(t)]).range([56,4]);var a=d3.line().x((t,e)=>n(e)).y(t=>e(t));r.selectAll("*").remove(),r.append("path").datum(t).attr("fill","none").attr("stroke","black").attr("stroke-width",1).attr("d",a)}return a(n),t=>{for(;100<n.length;)n.shift();n.push(t),a(n),document.querySelector(e+" .value").innerText=t}}if(!(!n||n.clientWidth<960||n.clientHeight<400)){d3.select(a).append("div").attr("class","widget messages").html(`<span class="text">Messages/s:</span>
            <span class="text value"></span>
            <svg class="sparkline"></svg>`);let t=T(a+" .messages"),e=(d3.select(a).append("div").attr("class","widget clients").html(`<span class="text">Connected clients:</span>
            <span class="text value"></span>
            <svg class="sparkline"></svg>`),T(a+" .clients")),n=(d3.select(a).append("div").attr("class","widget subscriptions").html(`<span class="text">Subscriptions:</span>
            <span class="text value"></span>
            <svg class="sparkline"></svg>`),T(a+" .subscriptions"));setInterval(()=>{t(L),L=0,e(u.filter(t=>"client"===t.type&&t.ttl>+Date.now()).length),n(u.filter(t=>"subscription"===t.type&&t.ttl>+Date.now()).length)},1e3)}}