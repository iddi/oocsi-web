function oocsiGraphVis(a,t=""){const e=document.querySelector(a);if(!e)return;let r="",n=t;const l=d3.select(a).append("svg").attr("class","graph").attr("width",e.clientWidth).attr("height",e.clientHeight);var t=+l.attr("width"),s=+l.attr("height");const i=d3.forceSimulation().force("link",d3.forceLink().id(t=>t.id).distance(120).strength(t=>t.strength||0)).force("charge",d3.forceManyBody().strength(-50)).force("center",d3.forceCenter(t/2,s/2)),c={id:"center",type:"server",label:"",value:2};let o=[c],d=1,p=[],u=l.append("g"),g=l.append("g"),h=l.append("g");const f=()=>{const t=u.selectAll(".link").data(p).join("line").attr("class",t=>"client"===t.type?"link client":"channel"===t.type?"link channel":"subscription"===t.type?"link subscription":"link").attr("opacity",t=>{return e=t,0==r.length||v(e.source)&&v(e.target)?t.ttl<+Date.now()?.5:1:0;var e}),e=g.selectAll(".node").data(o,t=>t.id).attr("opacity",t=>v(t)?1:0).join(t=>t.append("circle").attr("class",t=>"node "+t.type).attr("r",t=>5*t.value).call(d3.drag().on("start",y).on("drag",x).on("end",m)),t=>t,t=>t.remove()),n=h.selectAll(".label").data(o,t=>t.id).attr("opacity",t=>v(t)?1:0).join(t=>t.append("text").attr("class","label").text(t=>t.label).attr("dx",10).attr("dy",3),t=>t,t=>t.remove());i.nodes(o).on("tick",()=>{t.attr("x1",t=>t.source.x).attr("y1",t=>t.source.y).attr("x2",t=>t.target.x).attr("y2",t=>t.target.y),e.attr("cx",t=>t.x).attr("cy",t=>t.y),n.attr("x",t=>t.x).attr("y",t=>t.y)}),i.force("link").links(p),i.alpha(1).restart()};function v(t){return 0==r.length||"client"!==t.type||t.chains.some(t=>t.toLowerCase().includes(r))}function y(t,e){t.active||i.alphaTarget(.3).restart(),e.fx=e.x,e.fy=e.y}function x(t,e){e.fx=t.x,e.fy=t.y}function m(t,e){t.active||i.alphaTarget(0),e.fx=null,e.fy=null}function w(t){var n=t.split("/").filter(t=>0<t.length);let a=c,r="clients";for(index in n){var s=n[index];r+="/"+s,(target=a)!==c&&target.chains.push(t);let e=k(r);e?p.find(t=>t.source===e&&t.target===target)||(S(e,target,"client",1),f()):(S(e=b(r,s,0,"client",t),target,"client",1),o.push(e),f()),a=e}}function b(t,e,n,a,r){return{id:d++,qualName:t,label:e,value:1,type:a,chains:[r]}}function k(e){return o.find(t=>t.qualName===e)}function S(t,e,n,a){p.push({id:d++,source:t,target:e,type:n,strength:a,ttl:+Date.now()+3e4})}function A(e,a,r=[]){if(r=Array.isArray(r)?r:[r],0==n.length||a.toLowerCase().includes(n)){L++;let t=k("clients/"+e),n=(t||(w(e),t=k("clients/"+e)),k("channels/"+a));if(!n){{var s=a;var i=s.split("/").filter(t=>0<t.length);let t=c,n="channels";for(index in i){var l=i[index];n+="/"+l,target=t;let e=k(n);e?p.find(t=>t.source===e&&t.target===target)||(S(e,target,"channel",.5),f()):(S(e=b(n,l,0,"channel"),target,"channel",target===c?1:.2),o.push(e),f()),t=e}}n=k("channels/"+a)}s=function(t,e){var n=[t],a=new Set,r=new Map;a.add(t.id);for(;0<n.length;){const i=n.shift();if(i.id===e.id){var s=[];let t=e;for(;t;)s.unshift(t),t=r.get(t.id);return s}for(const l of p.filter(t=>"subscription"!==t.type).filter(t=>t.source.id===i.id||t.target.id===i.id).map(t=>t.source.id===i.id?t.target:t.source))a.has(l.id)||(a.add(l.id),r.set(l.id,i),n.push(l))}return[]}(t,n);C(s,e.includes("tool")&&e.includes("gen")?" generated":""),setTimeout(()=>{r.filter(t=>2<t.length).forEach(t=>{let e=k("clients/"+t);e||(w(t),e=k("clients/"+t)),p.find(t=>t.source===n&&t.target===e)||(S(n,e,"subscription",0),f()),C([n,e]," shadow")})},800*(s.length-1))}}function C(r,t=""){if(!(r.length<2)&&r.every(t=>v(t))){const i=l.append("circle").attr("class","moving-dot"+t).attr("r",4).attr("cx",r[0].x).attr("cy",r[0].y);var e=800*(r.length-1);var s=e/(100*(r.length-1));for(let a=0;a<r.length-1;a++){var n=function(e,n){return p.find(t=>t.source===e&&t.target===n||t.source===n&&t.target===e)}(r[a],r[a+1]);n&&(n.ttl=+Date.now()+3e4);for(let n=0;n<=100;n++)setTimeout(()=>{var t=n/100,e=r[a].x+t*(r[a+1].x-r[a].x),t=r[a].y+t*(r[a+1].y-r[a].y);i.attr("cx",e).attr("cy",t)},n*s+a*e/(r.length-1))}setTimeout(()=>{i.remove()},e)}}f(),new EventSource("/subscribe/OOCSI_events").onmessage=function(t){t=JSON.parse(t.data);t&&A(t.PUB,t.CHANNEL,t.SUB)},!e||e.clientWidth<960||e.clientHeight<400||(d3.select(a).append("div").attr("class","widget search").html(`<span class="text">Filter clients:</span>
                <br>
                <input type="search">`),d3.select(a+" .search input").on("input",()=>{r=d3.select(a+" .search input").property("value").toLowerCase(),f()}));let L=0;function T(e){const r=d3.select(e+" .sparkline").attr("width",300).attr("height",60);let n=[0,0,0,0];function a(t){const n=d3.scaleLinear().domain([0,t.length-1]).range([0,3*(t.length-1)]),e=d3.scaleLinear().domain([0,d3.max(t)]).range([56,4]);var a=d3.line().x((t,e)=>n(e)).y(t=>e(t));r.selectAll("*").remove(),r.append("path").datum(t).attr("fill","none").attr("stroke","black").attr("stroke-width",1).attr("d",a)}return a(n),t=>{for(;100<n.length;)n.shift();n.push(t),a(n),document.querySelector(e+" .value").innerText=t}}if(!(!e||e.clientWidth<960||e.clientHeight<400)){d3.select(a).append("div").attr("class","widget messages").html(`<span class="text">Messages/s:</span>
            <span class="text value"></span>
            <svg class="sparkline"></svg>`);let t=T(a+" .messages"),e=(d3.select(a).append("div").attr("class","widget clients").html(`<span class="text">Connected clients:</span>
            <span class="text value"></span>
            <svg class="sparkline"></svg>`),T(a+" .clients")),n=(d3.select(a).append("div").attr("class","widget subscriptions").html(`<span class="text">Subscriptions:</span>
            <span class="text value"></span>
            <svg class="sparkline"></svg>`),T(a+" .subscriptions"));setInterval(()=>{t(L),L=0,e(p.filter(t=>"client"===t.type&&t.ttl>+Date.now()).length),n(p.filter(t=>"subscription"===t.type&&t.ttl>+Date.now()).length)},1e3)}}